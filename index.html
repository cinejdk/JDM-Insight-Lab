<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JDM Insight Lab v3.0</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { 
            --primary-color: #2c3e50; 
            --accent-color: #4CAF50; /* ì¸ì‚¬ì´íŠ¸ ë©ì€ ë…¹ìƒ‰ í…Œë§ˆ */
            --bg-color: #121212; /* ë‹¤í¬ ëª¨ë“œ ë°°ê²½ */
            --card-bg: #1e1e1e; 
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --border-color: #333;
            --nav-height: 65px; 
            --holiday-color: #e74c3c; 
            --sat-color: #3498db; 
        }
        
        body { font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; padding-bottom: var(--nav-height); box-sizing: border-box; }
        *, *:before, *:after { box-sizing: border-box; }

        /* ìƒë‹¨ í—¤ë” */
        header { background: #000; padding: 15px 20px; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 1.2rem; font-weight: 700; color: #fff; }
        .version-badge { background: var(--accent-color); color: #fff; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
        
        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; } .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #loginOverlay input { width: 220px; padding: 15px; font-size: 1.5rem; text-align: center; border-radius: 12px; border: 1px solid #333; background: #222; color: white; margin-top: 10px; letter-spacing: 5px; }
        #loginOverlay button { margin-top: 20px; padding: 12px 40px; background: var(--accent-color); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }

        /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
        .calendar-wrapper { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); width: 100%; }
        .day-header { text-align: center; font-size: 0.9rem; color: var(--text-sub); padding: 12px 0; font-weight: 600; border-bottom: 1px solid var(--border-color); }
        .day-header.sun { color: var(--holiday-color); }
        .day-header.sat { color: var(--sat-color); }
        
        .cal-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; font-size: 0.95rem; cursor: pointer; padding-top: 6px; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); position: relative; color: var(--text-main); }
        .cal-day:nth-child(7n) { border-right: none; }
        .cal-day:hover { background: #252525; }
        .cal-day.today { border: 1px solid var(--accent-color); }
        .cal-day.today .day-num { background: var(--accent-color); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.85rem; }
        .cal-day.active-select { background: rgba(76, 175, 80, 0.2); }
        
        .day-num { margin-bottom: 2px; }
        .dot { width: 6px; height: 6px; background: var(--accent-color); border-radius: 50%; margin-top: 4px; display: block; }
        .cal-events-pc { display: none; width: 100%; margin-top: 2px; padding: 0 2px; box-sizing: border-box; }
        
        @media (min-width: 768px) {
            .cal-day { aspect-ratio: auto; min-height: 120px; height: 100%; align-items: flex-start; padding: 8px; }
            .dot { display: none; } .cal-events-pc { display: block; }
            .cal-event-item { font-size: 0.8rem; background: #2c2c2c; color: #ddd; padding: 4px 8px; border-radius: 4px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; border-left: 3px solid var(--accent-color); }
            .more-items { font-size: 0.75rem; color: #888; text-align: right; padding-right: 5px; }
        }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .memo-card { background: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); cursor: pointer; }
        .memo-card h3 { margin: 0 0 10px 0; color: #fff; font-size: 1.1rem; }
        .memo-card p { color: #aaa; font-size: 0.9rem; margin: 0; line-height: 1.5; }
        
        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        input, select, textarea { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid var(--border-color); border-radius: 10px; box-sizing: border-box; font-size: 1rem; background: #2c2c2c; color: #fff; font-family: 'Pretendard', sans-serif; }
        textarea { min-height: 300px; line-height: 1.6; resize: vertical; font-family: 'Consolas', monospace; }
        input:focus, textarea:focus { border-color: var(--accent-color); outline: none; }
        
        .btn-save { width: 100%; padding: 16px; background: var(--accent-color); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; cursor: pointer; }

        /* íƒœê·¸ ìŠ¤íƒ€ì¼ */
        .tag-select-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .tag-chip-btn { padding: 6px 12px; border-radius: 20px; border: 1px solid #444; background: #2c2c2c; color: #aaa; font-size: 0.9rem; cursor: pointer; }
        .tag-chip-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .card-tags { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px; }
        .mini-tag { font-size: 0.75rem; background: #333; color: var(--accent-color); padding: 2px 8px; border-radius: 12px; border: 1px solid #444; }

        /* ë·°ì–´ ëª¨ë‹¬ (ë§ˆí¬ë‹¤ìš´) */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); width:95%; max-width:800px; padding:30px; border-radius: 16px; max-height:85vh; overflow-y:auto; border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .view-body { color: #ddd; line-height: 1.7; font-size: 1rem; }
        .view-body code { background: #333; padding: 2px 5px; border-radius: 4px; color: #ff9800; font-family: monospace; }
        .view-body pre { background: #111; padding: 15px; border-radius: 8px; overflow-x: auto; margin: 15px 0; }
        .view-body blockquote { border-left: 4px solid var(--accent-color); margin: 0; padding-left: 15px; color: #888; }
        .view-body img { max-width: 100%; border-radius: 8px; }

        /* í•˜ë‹¨ ë‚´ë¹„ê²Œì´ì…˜ */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: #1e1e1e; display: flex; border-top: 1px solid #333; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; text-align: center; padding: 10px; color: #666; font-size: 0.75rem; cursor: pointer; }
        .nav-item.active { color: var(--accent-color); font-weight: bold; }
        .nav-icon { font-size: 1.5rem; display: block; margin-bottom: 4px; }
        
        /* ìœ í‹¸ë¦¬í‹° */
        .search-bar-area { display: flex; gap: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <form onsubmit="event.preventDefault(); checkPass();" style="text-align:center;">
        <h2 style="color:var(--accent-color);">ğŸ§ª JDM Insight Lab</h2>
        <p style="color:#888;">Access Verification</p>
        <input type="password" id="passInput" maxlength="4" placeholder="****">
        <br>
        <button type="submit">ENTER</button>
    </form>
</div>

<header>
    <h1>JDM Insight Lab <span class="version-badge">v3.0</span></h1>
    <button onclick="changePassword()" style="background:none; border:none; font-size:1.2rem; cursor:pointer; color:#666;">ğŸ”’</button>
</header>

<div class="container">
    
    <div id="tab-calendar" class="tab-content active">
        <div style="display:flex; justify-content:space-between; align-items:center; background:var(--card-bg); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid var(--border-color);">
            <button onclick="changeMonth(-1)" style="border:none; background:none; font-size:1.5rem; cursor:pointer; color:var(--text-main);">â—€</button>
            <h2 id="currentMonth" style="margin:0; font-size:1.3rem; color:#fff;"></h2>
            <button onclick="changeMonth(1)" style="border:none; background:none; font-size:1.5rem; cursor:pointer; color:var(--text-main);">â–¶</button>
        </div>
        <div class="calendar-wrapper">
            <div id="calendarGrid" class="calendar-grid"></div>
        </div>
        <div id="calendarMemos" style="margin-top:20px;"></div>
    </div>

    <div id="tab-list" class="tab-content">
        <div class="search-bar-area">
            <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ (í‚¤ì›Œë“œ, íƒœê·¸)" onkeyup="renderMemos()">
        </div>
        <div id="memoList"></div>
    </div>

    <div id="tab-write" class="tab-content">
        <div style="background:var(--card-bg); padding:20px; border-radius:16px; border:1px solid var(--border-color);">
            <h3 style="margin-top:0; color:var(--accent-color);">âœï¸ ìƒˆ ì¸ì‚¬ì´íŠ¸ ê¸°ë¡</h3>
            
            <label style="color:var(--text-sub); font-size:0.9rem;">Date (ë‚ ì§œ)</label>
            <input type="date" id="inputDate">

            <label style="color:var(--text-sub); font-size:0.9rem;">Context (ì§ˆë¬¸ ì˜ë„ & ë§¥ë½)</label>
            <input type="text" id="inputContext" placeholder="ì™œ ì´ ì§ˆë¬¸ì„ í–ˆë‚˜ìš”? (ì œëª© ì—­í• )">

            <label style="color:var(--text-sub); font-size:0.9rem;">Gemini Response (AI ë‹µë³€)</label>
            <textarea id="inputResponse" placeholder="ì›Œë“œ/í•œê¸€ì—ì„œ ë³µì‚¬í•œ í…ìŠ¤íŠ¸ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (ë§ˆí¬ë‹¤ìš´ ì§€ì›)"></textarea>
            
            <label style="color:var(--text-sub); font-size:0.9rem;">Tags (íƒœê·¸ ì„ íƒ)</label>
            <div id="inputTagContainer" class="tag-select-container"></div>
            
            <button class="btn-save" onclick="saveNewMemo()">ğŸ’¾ ì € ì¥ í•˜ ê¸°</button>
        </div>
    </div>

    <div id="tab-data" class="tab-content">
        <div style="background:var(--card-bg); padding:25px; border-radius:16px; text-align:center; border:1px solid var(--border-color);">
            <h3>ğŸ’¾ ë°ì´í„° ì„¼í„°</h3>
            <div style="background:#2c2c2c; padding:20px; border-radius:12px; margin-bottom:20px; text-align:left;">
                <strong style="color:#f39c12;">ğŸ“‚ ë°±ì—… íŒŒì¼ë¡œ ë³µì›</strong>
                <input type="file" id="restoreInput" onchange="restoreData(this)" style="margin-top:10px;">
            </div>
            <button onclick="backupData()" class="btn-save" style="background:#27ae60; margin-bottom:12px;">ğŸ“¤ ì „ì²´ ë°±ì—… (Backup)</button>
            <button onclick="resetApp()" class="btn-save" style="background:#c0392b;">âš ï¸ ì•± ì´ˆê¸°í™”</button>
        </div>
    </div>
</div>

<div id="viewModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:15px;">
            <div>
                <div id="viewTagList" style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:5px;"></div>
                <span id="viewDate" style="color:var(--accent-color); font-weight:bold;"></span>
            </div>
            <button onclick="closeViewModal()" style="background:none; border:none; color:#666; font-size:2rem; cursor:pointer;">Ã—</button>
        </div>
        <h2 id="viewTitle" style="color:#fff; margin-top:0;"></h2>
        <div id="viewBody" class="view-body"></div>
        
        <div style="margin-top:30px; display:flex; gap:10px;">
            <button onclick="deleteFromView()" style="flex:1; padding:10px; background:#c0392b; color:white; border:none; border-radius:8px; cursor:pointer;">ì‚­ì œ</button>
            <button onclick="closeViewModal()" style="flex:2; padding:10px; background:#444; color:white; border:none; border-radius:8px; cursor:pointer;">ë‹«ê¸°</button>
        </div>
        <input type="hidden" id="viewIdHidden">
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('calendar')"><span class="nav-icon">ğŸ“…</span>í™ˆ</div>
    <div class="nav-item" onclick="switchTab('list')"><span class="nav-icon">ğŸ“‹</span>ëª©ë¡</div>
    <div class="nav-item" onclick="switchTab('write')"><span class="nav-icon">âœï¸</span>ê¸°ë¡</div>
    <div class="nav-item" onclick="switchTab('data')"><span class="nav-icon">ğŸ’¾</span>ë°ì´í„°</div>
</nav>

<script>
    // --- ì„¤ì • ë° DB ì´ˆê¸°í™” ---
    const DB_NAME = 'JDMInsightDB_v3'; // ì•„ì¹´ì´ë¸Œì™€ DB ë¶„ë¦¬
    const STORE_NAME = 'insights';
    let db;
    let currDate = new Date();
    // ê¸°ë³¸ íƒœê·¸ì…‹
    let myTags = JSON.parse(localStorage.getItem('insightTags')) || ['#ê±´ì„¤ì‹¤ë¬´', '#ì² í•™', '#ì½”ë”©', '#ìŒì•…', '#ê°œì¸ì‚¬'];
    let inputSelectedTags = new Set();

    // ë¹„ë°€ë²ˆí˜¸ ë¡œì§
    function getPassword() { return localStorage.getItem('appPass') || "0403"; }
    function checkPass() {
        if(document.getElementById('passInput').value === getPassword()) {
            document.getElementById('loginOverlay').style.display = 'none';
        } else { alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'); document.getElementById('passInput').value=''; }
    }
    function changePassword() {
        const cur = prompt("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸:"); if(cur!==getPassword()) return alert("í‹€ë ¸ìŠµë‹ˆë‹¤.");
        const newP = prompt("ìƒˆ ë¹„ë°€ë²ˆí˜¸:"); if(newP) { localStorage.setItem('appPass', newP); alert("ë³€ê²½ ì™„ë£Œ."); }
    }

    // DB ì—°ê²°
    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = e => { db = e.target.result; if(!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, {keyPath:'id'}); };
    request.onsuccess = e => { db = e.target.result; initApp(); };

    function initApp() { 
        document.getElementById('inputDate').value = new Date().toISOString().substring(0, 10);
        renderTagSelector();
        renderCalendar(); 
        renderMemos(); 
    }

    // --- íƒ­ ì „í™˜ ---
    function switchTab(tab) {
        window.scrollTo(0, 0); 
        document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        document.getElementById('tab-'+tab).classList.add('active');
        const tabs = ['calendar','list','write','data'];
        document.querySelectorAll('.nav-item')[tabs.indexOf(tab)].classList.add('active');
        
        if(tab === 'list') renderMemos();
        if(tab === 'calendar') { currDate = new Date(); renderCalendar(); }
    }

    // --- íƒœê·¸ ê´€ë¦¬ ---
    function renderTagSelector() {
        const container = document.getElementById('inputTagContainer');
        container.innerHTML = '';
        myTags.forEach(tag => {
            const btn = document.createElement('span');
            btn.className = 'tag-chip-btn' + (inputSelectedTags.has(tag) ? ' active' : '');
            btn.innerText = tag;
            btn.onclick = () => {
                if(inputSelectedTags.has(tag)) inputSelectedTags.delete(tag); else inputSelectedTags.add(tag);
                renderTagSelector();
            };
            container.appendChild(btn);
        });
        // íƒœê·¸ ì¶”ê°€ ë²„íŠ¼
        const addBtn = document.createElement('span');
        addBtn.className = 'tag-chip-btn';
        addBtn.innerText = '+ ì¶”ê°€';
        addBtn.style.color = '#fff';
        addBtn.onclick = () => {
            const newTag = prompt("ìƒˆ íƒœê·¸ ì´ë¦„ (#í¬í•¨):");
            if(newTag) { myTags.push(newTag); localStorage.setItem('insightTags', JSON.stringify(myTags)); renderTagSelector(); }
        };
        container.appendChild(addBtn);
    }

    // --- ì €ì¥ ë¡œì§ ---
    function saveNewMemo() {
        const dateVal = document.getElementById('inputDate').value;
        const context = document.getElementById('inputContext').value.trim();
        const response = document.getElementById('inputResponse').value.trim();
        const tags = Array.from(inputSelectedTags);

        if(!context || !response) return alert('ë§¥ë½ê³¼ ë‹µë³€ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).add({
            id: Date.now(),
            dateStr: dateVal, // YYYY-MM-DD
            title: context,   // ì œëª© í•„ë“œì— ì§ˆë¬¸(ë§¥ë½) ì €ì¥
            content: response, // ë‚´ìš© í•„ë“œì— AI ë‹µë³€ ì €ì¥
            tags: tags
        });

        tx.oncomplete = () => {
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            document.getElementById('inputContext').value = "";
            document.getElementById('inputResponse').value = "";
            inputSelectedTags.clear();
            renderTagSelector();
            switchTab('calendar');
        };
    }

    // --- ìº˜ë¦°ë” ë Œë”ë§ ---
    async function renderCalendar() {
        const y = currDate.getFullYear(), m = currDate.getMonth();
        document.getElementById('currentMonth').innerText = `${y}. ${m+1}`;
        const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
        
        const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
        days.forEach((d, i) => {
            grid.innerHTML += `<div class="day-header ${i===0?'sun':''} ${i===6?'sat':''}">${d}</div>`;
        });

        const first = new Date(y,m,1).getDay(), last = new Date(y,m+1,0).getDate();
        for(let i=0; i<first; i++) grid.innerHTML += `<div></div>`;
        
        const memos = await getAll();
        
        for(let d=1; d<=last; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayMemos = memos.filter(m => m.dateStr === dateStr);
            
            const div = document.createElement('div');
            div.className = 'cal-day';
            if(dateStr === new Date().toISOString().substring(0,10)) div.classList.add('today');
            
            // ëª¨ë°”ì¼ìš© ì 
            const dotHtml = dayMemos.length > 0 ? `<div class="dot"></div>` : '';
            // PCìš© ì œëª© ë¦¬ìŠ¤íŠ¸
            let pcEvents = '';
            dayMemos.slice(0,3).forEach(m => {
                pcEvents += `<div class="cal-event-item">${m.title}</div>`;
            });
            if(dayMemos.length > 3) pcEvents += `<div class="more-items">+${dayMemos.length-3}</div>`;

            div.innerHTML = `<span class="day-num">${d}</span>${dotHtml}<div class="cal-events-pc">${pcEvents}</div>`;
            div.onclick = () => showDayMemos(dateStr, dayMemos);
            grid.appendChild(div);
        }
        document.getElementById('calendarMemos').innerHTML = ''; // ì´ˆê¸°í™”
    }

    // ìº˜ë¦°ë” ë‚ ì§œ í´ë¦­ ì‹œ í•˜ë‹¨ ëª©ë¡ í‘œì‹œ
    function showDayMemos(dateStr, memos) {
        const box = document.getElementById('calendarMemos');
        if(memos.length === 0) {
            // ë°ì´í„° ì—†ìœ¼ë©´ ë°”ë¡œ ì…ë ¥ì°½ìœ¼ë¡œ ë‚ ì§œ ë„˜ê¸°ê¸°
            if(confirm('ì´ ë‚ ì§œì— ê¸°ë¡ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('inputDate').value = dateStr;
                switchTab('write');
            }
            return;
        }

        let html = `<div style="background:var(--card-bg); padding:15px; border-radius:12px; border:1px solid var(--border-color);">
            <h3 style="margin:0 0 15px 0; color:#fff;">ğŸ“… ${dateStr} ê¸°ë¡ (${memos.length})</h3>`;
        
        memos.forEach(m => {
            const tags = (m.tags||[]).map(t => `<span class="mini-tag">${t}</span>`).join(' ');
            html += `<div onclick="openViewModal(${m.id})" style="padding:12px; border-bottom:1px solid #333; cursor:pointer;">
                <div style="font-weight:bold; color:#fff; margin-bottom:5px;">Q. ${m.title}</div>
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#888;">
                    <span>${tags}</span>
                    <span>ë”ë³´ê¸° ></span>
                </div>
            </div>`;
        });
        html += `</div>`;
        box.innerHTML = html;
        // ìŠ¤í¬ë¡¤ ì´ë™
        box.scrollIntoView({ behavior: 'smooth' });
    }

    // --- ëª©ë¡ ë Œë”ë§ ---
    async function renderMemos() {
        const list = document.getElementById('memoList'); list.innerHTML = '';
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        let memos = await getAll();
        memos.sort((a,b) => b.dateStr.localeCompare(a.dateStr)); // ìµœì‹ ìˆœ

        memos.forEach(m => {
            if(keyword && !m.title.toLowerCase().includes(keyword) && !(m.tags||[]).join('').toLowerCase().includes(keyword)) return;
            
            const tagsHtml = (m.tags||[]).map(t => `<span class="mini-tag">${t}</span>`).join(' ');
            list.innerHTML += `
            <div class="memo-card" onclick="openViewModal(${m.id})">
                <div style="display:flex; justify-content:space-between; color:#888; font-size:0.8rem; margin-bottom:8px;">
                    <span>${m.dateStr}</span>
                    <div class="card-tags">${tagsHtml}</div>
                </div>
                <h3>Q. ${m.title}</h3>
                <p>${m.content.substring(0, 60)}...</p>
            </div>`;
        });
    }

    // --- ë·°ì–´ (ë§ˆí¬ë‹¤ìš´) ---
    async function openViewModal(id) {
        const m = await new Promise(r => db.transaction(STORE_NAME).objectStore(STORE_NAME).get(id).onsuccess = e => r(e.target.result));
        if(!m) return;
        
        document.getElementById('viewIdHidden').value = m.id;
        document.getElementById('viewTitle').innerText = "Q. " + m.title;
        document.getElementById('viewDate').innerText = m.dateStr;
        
        const tagsHtml = (m.tags||[]).map(t => `<span class="mini-tag">${t}</span>`).join(' ');
        document.getElementById('viewTagList').innerHTML = tagsHtml;
        
        // ë§ˆí¬ë‹¤ìš´ ë³€í™˜
        document.getElementById('viewBody').innerHTML = marked.parse(m.content);
        document.getElementById('viewModal').style.display = 'flex';
    }
    function closeViewModal() { document.getElementById('viewModal').style.display = 'none'; }

    function deleteFromView() {
        if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const id = Number(document.getElementById('viewIdHidden').value);
        db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).delete(id).onsuccess = () => {
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeViewModal();
            renderCalendar();
            renderMemos();
        };
    }

    // --- ìœ í‹¸ë¦¬í‹° ---
    function getAll() { return new Promise(r => db.transaction(STORE_NAME,'readonly').objectStore(STORE_NAME).getAll().onsuccess = e => r(e.target.result)); }
    
    function backupData() { 
        getAll().then(data => {
            if(data.length==0) return alert('ë°ì´í„° ì—†ìŒ'); 
            const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Insight_Backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }); 
    }
    function restoreData(input) { 
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const data = JSON.parse(e.target.result);
            const tx = db.transaction(STORE_NAME, 'readwrite');
            data.forEach(item => tx.objectStore(STORE_NAME).put(item));
            tx.oncomplete = () => { alert('ë³µì› ì™„ë£Œ'); location.reload(); };
        };
        reader.readAsText(file);
    }
    function resetApp() { if(confirm('ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { db.transaction(STORE_NAME,'readwrite').objectStore(STORE_NAME).clear().onsuccess=()=>{ location.reload(); }; } }
</script>
</body>
</html>
