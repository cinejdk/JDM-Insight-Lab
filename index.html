<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JDM Insight Lab v3.4</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { 
            --primary-color: #2c3e50; 
            --accent-color: #4CAF50; 
            --bg-color: #f0f2f5; 
            --card-bg: #ffffff; 
            --nav-height: 65px; 
            --holiday-color: #e74c3c; 
            --sat-color: #2980b9; 
        }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: #333; margin: 0; padding-bottom: var(--nav-height); box-sizing: border-box; }
        *, *:before, *:after { box-sizing: border-box; }

        header { background: var(--primary-color); padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; color: white; }
        header h1 { margin: 0; font-size: 1.3rem; font-weight: 700; flex-grow: 1; text-align: center; margin-left: 40px; }
        
        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; } .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #loginOverlay input { width: 220px; padding: 15px; font-size: 1.5rem; text-align: center; border-radius: 12px; border: none; margin-top: 10px; letter-spacing: 5px; }
        #loginOverlay button { margin-top: 20px; padding: 12px 40px; background: var(--accent-color); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }

        /* ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ */
        .calendar-wrapper { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #e0e0e0; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; z-index: 20; }
        /* í™”ì‚´í‘œ ë²„íŠ¼ ê°•í™”: z-index ë° í„°ì¹˜ ì˜ì—­ í™•ëŒ€ */
        .nav-arrow-btn { border: none; background: transparent; font-size: 2rem; cursor: pointer; color: var(--primary-color); padding: 5px 20px; z-index: 30; user-select: none; }
        .nav-arrow-btn:active { opacity: 0.5; transform: scale(0.95); }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); width: 100%; }
        .day-header { text-align: center; font-size: 0.9rem; color: #555; padding: 12px 0; font-weight: 600; background-color: #f8f9fa; border-bottom: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0; }
        .day-header:nth-child(7n) { border-right: none; }
        .day-header.sun { color: var(--holiday-color); }
        .day-header.sat { color: var(--sat-color); }
        
        .cal-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; font-size: 0.95rem; cursor: pointer; padding-top: 6px; border-right: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; background: white; position: relative; }
        .cal-day:nth-child(7n) { border-right: none; }
        .cal-day.today { background: #e8f5e9; }
        .cal-day.today .day-num { background: var(--accent-color); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.85rem; }
        .cal-day.has-memo .day-num { font-weight: bold; text-decoration: underline; text-underline-offset: 3px; }
        /* ì„ íƒëœ ë‚ ì§œ ê°•ì¡° */
        .cal-day.selected-day { background: #fff3e0; box-shadow: inset 0 0 0 2px #ff9800; }
        
        .day-num { margin-bottom: 2px; }
        .holiday-name { font-size: 0.7rem; color: var(--holiday-color); font-weight: bold; margin-bottom: 2px; text-align: center; word-break: keep-all; line-height: 1.1; }
        .cal-day.sun .day-num, .cal-day.holiday .day-num { color: var(--holiday-color); }
        .cal-day.sat .day-num { color: var(--sat-color); }
        .dot { width: 6px; height: 6px; background: var(--accent-color); border-radius: 50%; margin-top: 4px; display: block; }
        .cal-events-pc { display: none; width: 100%; margin-top: 2px; padding: 0 2px; box-sizing: border-box; }
        
        @media (min-width: 768px) {
            .cal-day { aspect-ratio: auto; min-height: 130px; height: 100%; align-items: flex-start; padding: 8px; }
            .dot { display: none; } .cal-events-pc { display: block; }
            .cal-event-item { font-size: 0.8rem; background: #f1f3f5; color: #495057; padding: 4px 8px; border-radius: 4px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; border-left: 3px solid var(--accent-color); cursor: pointer; }
            .more-items { font-size: 0.75rem; color: #888; text-align: right; margin-top: 2px; }
        }

        /* ê¸°íƒ€ ìŠ¤íƒ€ì¼ */
        .memo-card { background: var(--card-bg); padding: 20px; border-radius: 16px; margin-bottom: 15px; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; cursor: pointer; }
        .memo-card.selected { border: 2px solid var(--accent-color); background: #f1f8e9; }
        .check-circle { position: absolute; top: 15px; right: 15px; width: 24px; height: 24px; border-radius: 50%; border: 2px solid #ddd; background: white; display: none; }
        .memo-card.selection-mode .check-circle { display: block; }
        .memo-card.selected .check-circle { background: var(--accent-color); border-color: var(--accent-color); }
        .memo-card.selected .check-circle::after { content: 'âœ”'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; }

        input, select { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 1rem; background: #fff; }
        textarea.markdown-editor { width: 100%; min-height: 300px; padding: 14px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 1rem; font-family: 'Consolas', monospace; line-height: 1.6; resize: vertical; background: #fafafa; }
        textarea.markdown-editor:focus { border-color: var(--accent-color); outline: none; background: #fff; }

        .tag-select-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; padding: 5px 0; }
        .tag-chip-btn { padding: 8px 14px; border-radius: 20px; border: 1px solid #ddd; background: #f8f9fa; color: #555; font-size: 0.9rem; cursor: pointer; }
        .tag-chip-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); font-weight: bold; }
        .card-tags { display: flex; gap: 5px; flex-wrap: wrap; margin-left: auto; justify-content: flex-end;}
        .mini-tag { font-size: 0.75rem; background: #e8f5e9; color: var(--accent-color); padding: 2px 8px; border-radius: 12px; font-weight: bold; border: 1px solid #c8e6c9; }

        .btn-save { width: 100%; padding: 16px; background: var(--accent-color); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        
        .link-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .link-row input { margin-bottom: 0; flex-grow: 1; }
        .btn-del-link { background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; flex-shrink: 0; }
        .btn-add-link { background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; margin-bottom: 15px; display: inline-block; }
        .file-input-wrapper { border: 2px dashed #ddd; padding: 20px; text-align: center; border-radius: 10px; background: #fafafa; cursor: pointer; margin-bottom: 15px; transition: 0.2s; }
        .file-list-display { font-size: 0.9rem; color: #555; text-align: left; margin-top: 10px; }
        
        .attachment-section { margin-top: 25px; border-top: 1px solid #eee; padding-top: 15px; }
        .attach-item { display: flex; align-items: center; gap: 10px; background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #eee; text-decoration: none; color: #333; }
        .img-preview-box { margin-top: 10px; text-align: center; background: #222; padding: 10px; border-radius: 8px; }
        .img-preview-box img { max-width: 100%; border-radius: 4px; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: white; display: flex; border-top: 1px solid #eee; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; text-align: center; padding: 10px; color: #999; font-size: 0.75rem; cursor: pointer; }
        .nav-item.active { color: var(--accent-color); font-weight: bold; }
        .nav-icon { font-size: 1.5rem; display: block; margin-bottom: 4px; }
        
        #bulkDeleteBar { position: fixed; bottom: var(--nav-height); left: 0; width: 100%; background: #e74c3c; color: white; padding: 15px; text-align: center; font-weight: bold; cursor: pointer; display: none; z-index: 900; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        
        .search-bar-area { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .search-row { display: flex; gap: 5px; align-items: center; width: 100%; }
        .search-row select, .search-row input { flex-grow: 1; margin-bottom: 0; }
        .icon-btn { background: #95a5a6; color: white; border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 1.2rem; min-width: 45px; }
        .btn-select-mode { background: #2c3e50; }
        .btn-select-mode.active { background: var(--accent-color); }
        .date-filter-row { display: flex; gap: 5px; align-items: center; }
        
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; backdrop-filter: blur(4px); }
        .modal-content { background:white; width:90%; max-width:600px; padding:30px; border-radius:20px; max-height:85vh; overflow-y:auto; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .close-btn { font-size: 2rem; border: none; background: none; cursor: pointer; color: #aaa; line-height: 1; margin-left: 10px;}
        
        .view-body { line-height: 1.7; font-size: 1.05rem; color: #333; }
        .view-body code { background: #f1f1f1; padding: 2px 5px; border-radius: 4px; color: #e83e8c; font-family: monospace; }
        .view-body pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 8px; overflow-x: auto; margin: 15px 0; }
        .view-body blockquote { border-left: 4px solid var(--accent-color); margin: 0; padding-left: 15px; color: #777; background: #f9f9f9; }
        
        .tag-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .tag-item { background: #f1f3f5; padding: 8px 12px; border-radius: 20px; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        .tag-del-btn { color: #e74c3c; font-weight: bold; cursor: pointer; margin-left: 5px; }
    </style>
</head>
<body>
<div id="loginOverlay">
    <form onsubmit="event.preventDefault(); checkPass();" style="text-align:center;">
        <h2 style="color:var(--accent-color);">ğŸ§ª JDM Insight Lab</h2>
        <p>Access Verification</p>
        <input type="password" id="passInput" maxlength="4" placeholder="****">
        <br>
        <button type="submit">ENTER</button>
    </form>
</div>

<header>
    <h1>JDM Insight Lab v3.4</h1>
    <button onclick="changePassword()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; padding:5px; color:rgba(255,255,255,0.8);">ğŸ”’</button>
</header>

<div class="container">
    <div id="tab-calendar" class="tab-content active">
        <div class="calendar-header">
            <button class="nav-arrow-btn" onclick="changeMonth(-1)">â—€</button>
            <h2 id="currentMonth" style="margin:0; font-size:1.3rem; color:var(--primary-color);"></h2>
            <button class="nav-arrow-btn" onclick="changeMonth(1)">â–¶</button>
        </div>
        <div class="calendar-wrapper">
            <div id="calendarGrid" class="calendar-grid"></div>
        </div>
        <div id="calendarMemos" style="margin-top:20px; text-align:center; color:#888;"></div>
    </div>

    <div id="tab-list" class="tab-content">
        <div class="search-bar-area">
            <div class="search-row">
                <button class="icon-btn btn-tag-config" onclick="openTagManager()" title="íƒœê·¸ ê´€ë¦¬">âš™ï¸</button>
                <button class="icon-btn btn-select-mode" id="selectModeBtn" onclick="toggleSelectMode()" title="ì„ íƒ ëª¨ë“œ">âœ…</button>
                <select id="listFilter" onchange="renderMemos()">
                    <option value="all">ì „ì²´ë³´ê¸°</option>
                </select>
            </div>
            <div class="search-row">
                <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ (ë‚´ìš©, íƒœê·¸)" onkeyup="renderMemos()">
            </div>
            <div class="date-filter-row">
                <input type="date" id="filterStartDate" onchange="renderMemos()">
                <span>~</span>
                <input type="date" id="filterEndDate" onchange="renderMemos()">
            </div>
        </div>
        <div id="memoList"></div>
    </div>

    <div id="tab-write" class="tab-content">
        <div style="background:var(--card-bg); padding:25px; border-radius:16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:var(--accent-color);">âœï¸ ìƒˆ ì¸ì‚¬ì´íŠ¸</h3>
                <button onclick="switchTab('calendar')" style="border:none; background:none; font-size:2rem; cursor:pointer; color:#aaa; line-height:1;">Ã—</button>
            </div>
            <label style="font-size:0.85rem; color:#666; font-weight:bold;">1. Context (ì§ˆë¬¸ ì˜ë„)</label>
            <input type="text" id="inputTitle" placeholder="ì™œ ì´ ì§ˆë¬¸ì„ í–ˆë‚˜ìš”?">
            <div style="margin-bottom:12px;">
                <label style="font-size:0.85rem; color:#666; font-weight:bold;">2. Date (ë‚ ì§œ)</label>
                <input type="date" id="inputDate" style="margin-bottom:0;">
            </div>
            <div style="margin-bottom:12px;">
                <label style="font-size:0.85rem; color:#666; font-weight:bold;">3. Tags (ë¶„ë¥˜)</label>
                <div id="inputTagContainer" class="tag-select-container"></div>
            </div>
            <label style="font-size:0.85rem; color:#666; font-weight:bold;">4. Gemini Response</label>
            <textarea id="inputContent" class="markdown-editor" placeholder="ë‹µë³€ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (Markdown ì§€ì›)"></textarea>
            <label style="font-size:0.85rem; color:#666; font-weight:bold; display:block; margin-top:15px;">ê´€ë ¨ ë§í¬</label>
            <div id="inputLinkContainer"></div>
            <button class="btn-add-link" onclick="addLinkField('inputLinkContainer')">+ ë§í¬ ì¶”ê°€</button>
            <label style="font-size:0.85rem; color:#666; font-weight:bold; display:block; margin-top:15px;">ğŸ“ íŒŒì¼ ì²¨ë¶€</label>
            <div class="file-input-wrapper" onclick="document.getElementById('inputFile').click()">
                <div style="font-size:2rem; color:#aaa;">â˜ï¸</div>
                <div style="font-weight:bold; color:#555;">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</div>
                <input type="file" id="inputFile" multiple style="display:none;" onchange="updateFileList(this)">
            </div>
            <div id="fileListDisplay" class="file-list-display"></div>
            <button class="btn-save" style="margin-top:20px;" onclick="saveNewMemo()">ğŸ’¾ ì € ì¥ í•˜ ê¸°</button>
        </div>
    </div>

    <div id="tab-data" class="tab-content">
        <div style="background:var(--card-bg); padding:25px; border-radius:16px; text-align:center; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
            <h3>ğŸ’¾ ë°ì´í„° ì„¼í„°</h3>
            <div style="background:#e8f5e9; padding:20px; border-radius:12px; margin-bottom:20px; border:2px solid var(--accent-color); text-align:left;">
                <strong style="color:var(--primary-color);">ğŸ“‚ ë°±ì—… íŒŒì¼ë¡œ ë³µì›</strong>
                <input type="file" id="restoreInput" onchange="restoreData(this)" style="background:white; border:1px solid #ccc; width:100%; margin-top:10px;">
            </div>
            <button onclick="backupData()" class="btn-save" style="background:#2980b9; margin-bottom:12px;">ğŸ“¤ ì „ì²´ ë°±ì—…</button>
            <button onclick="resetApp()" class="btn-save" style="background:#7f8c8d;">âš ï¸ ì•± ì´ˆê¸°í™”</button>
        </div>
    </div>
</div>

<div id="bulkDeleteBar" onclick="deleteSelectedMemos()">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ (<span id="selectedCount">0</span>)</div>
<div id="tagManagerModal" class="modal"><div class="modal-content"><div style="display:flex;justify-content:space-between;margin-bottom:15px;"><h2 style="margin:0;">âš™ï¸ íƒœê·¸ ê´€ë¦¬</h2><button class="close-btn" onclick="closeTagManager()">Ã—</button></div><div id="tagListDisplay" class="tag-list"></div><div style="display:flex;gap:5px;"><input type="text" id="newTagInput" placeholder="#ìƒˆíƒœê·¸"><button class="btn-save" onclick="addNewTag()" style="padding:10px;width:auto;">ì¶”ê°€</button></div></div></div>
<div id="viewModal" class="modal"><div class="modal-content"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:15px;border-bottom:1px solid #eee;padding-bottom:15px;"><div style="display:flex;flex-direction:column;gap:5px;"><div id="viewTagList" style="display:flex;gap:5px;flex-wrap:wrap;"></div><span id="viewDate" style="color:#888;font-size:0.95rem;"></span></div><div><input type="hidden" id="viewIdHidden"><button onclick="deleteFromView()" style="background:none;border:none;color:#e74c3c;cursor:pointer;font-weight:bold;margin-right:10px;">ì‚­ì œ</button><button class="close-btn" onclick="closeViewModal()">Ã—</button></div></div><h2 id="viewTitle" style="margin-top:0;color:#2c3e50;line-height:1.3;"></h2><div id="viewBody" class="view-body"></div><div id="viewLink" style="margin-top:20px;"></div><div id="viewAttachments" class="attachment-section" style="display:none;"><span class="attachment-label">ğŸ“ ì²¨ë¶€ íŒŒì¼</span><div id="attachList"></div></div></div></div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('calendar')"><span class="nav-icon">ğŸ“…</span>í™ˆ</div>
    <div class="nav-item" onclick="switchTab('list')"><span class="nav-icon">ğŸ“‹</span>ëª©ë¡</div>
    <div class="nav-item" onclick="switchTab('write')"><span class="nav-icon">âœï¸</span>ê¸°ë¡</div>
    <div class="nav-item" onclick="switchTab('data')"><span class="nav-icon">ğŸ’¾</span>ë°ì´í„°</div>
</nav>

<script>
    const DB_NAME = 'InsightDB_v3'; const STORE_NAME = 'insights';
    let db;
    let currDate = new Date();
    let myTags = JSON.parse(localStorage.getItem('insightTags')) || ['#ê±´ì„¤ì‹¤ë¬´','#ì² í•™','#ì½”ë“œ','#ìŒì•…','#ê°œì¸ì‚¬'];
    let isSelectionMode = false;
    let selectedIds = new Set();
    let inputSelectedTags = new Set();
    let currentSelectedDateKey = null; // ì„ íƒëœ ë‚ ì§œ (ìƒíƒœ ì €ì¥)

    // [2026ë…„ ê³µíœ´ì¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ]
    const HOLIDAYS = {
        '2025-01-01':'ì‹ ì •','2025-01-28':'ì„¤ë‚ ','2025-01-29':'ì„¤ë‚ ','2025-01-30':'ì„¤ë‚ ','2025-03-01':'ì‚¼ì¼ì ˆ','2025-05-05':'ì–´ë¦°ì´ë‚ ','2025-05-06':'ì„ê°€íƒ„ì‹ ì¼','2025-06-06':'í˜„ì¶©ì¼','2025-08-15':'ê´‘ë³µì ˆ','2025-10-03':'ê°œì²œì ˆ','2025-10-05':'ì¶”ì„','2025-10-06':'ì¶”ì„','2025-10-07':'ì¶”ì„','2025-10-09':'í•œê¸€ë‚ ','2025-12-25':'ì„±íƒ„ì ˆ',
        '2026-01-01':'ì‹ ì •', '2026-02-16':'ì„¤ë‚  ì—°íœ´', '2026-02-17':'ì„¤ë‚ ', '2026-02-18':'ì„¤ë‚  ì—°íœ´',
        '2026-03-01':'ì‚¼ì¼ì ˆ', '2026-03-02':'ëŒ€ì²´ê³µíœ´ì¼(ì‚¼ì¼ì ˆ)',
        '2026-05-05':'ì–´ë¦°ì´ë‚ ', '2026-05-24':'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', '2026-05-25':'ëŒ€ì²´ê³µíœ´ì¼(ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ )',
        '2026-06-03':'ì§€ë°©ì„ ê±°', '2026-06-06':'í˜„ì¶©ì¼',
        '2026-08-15':'ê´‘ë³µì ˆ', '2026-08-17':'ëŒ€ì²´ê³µíœ´ì¼(ê´‘ë³µì ˆ)',
        '2026-09-24':'ì¶”ì„ ì—°íœ´', '2026-09-25':'ì¶”ì„', '2026-09-26':'ì¶”ì„ ì—°íœ´',
        '2026-10-03':'ê°œì²œì ˆ', '2026-10-05':'ëŒ€ì²´ê³µíœ´ì¼(ê°œì²œì ˆ)',
        '2026-10-09':'í•œê¸€ë‚ ', '2026-12-25':'ì„±íƒ„ì ˆ'
    };
    
    function getPassword() { return localStorage.getItem('appPass') || "0403"; }
    function checkPass() { if(document.getElementById('passInput').value === getPassword()) { document.getElementById('loginOverlay').style.display = 'none'; } else { alert('í‹€ë ¸ìŠµë‹ˆë‹¤.'); } }
    function changePassword() { const cur = prompt("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸:"); if(cur!==getPassword()) return alert("í‹€ë ¸ìŠµë‹ˆë‹¤."); const newP = prompt("ìƒˆ ë¹„ë°€ë²ˆí˜¸:"); if(newP) { localStorage.setItem('appPass', newP); alert("ë³€ê²½ ì™„ë£Œ."); } }

    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = e => { db = e.target.result; if(!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, {keyPath:'id'}); };
    request.onsuccess = e => { db = e.target.result; initApp(); };

    function initApp() { updateTagSelects(); document.getElementById('inputDate').value = new Date().toISOString().substring(0, 10); addLinkField('inputLinkContainer'); renderCalendar(); renderMemos(); }

    function updateFileList(input) {
        const display = document.getElementById('fileListDisplay');
        if(input.files.length > 0) {
            let names = []; for(let i=0; i<input.files.length; i++) names.push(`ğŸ“„ ${input.files[i].name}`);
            display.innerText = names.join('\n'); display.style.color = "#2c3e50";
        } else { display.innerText = ""; }
    }
    function readFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve({ name: file.name, type: file.type, data: reader.result });
            reader.onerror = reject; reader.readAsDataURL(file);
        });
    }

    // --- [ìº˜ë¦°ë” ë¡œì§ ìˆ˜ì •: ë‚ ì§œ ê³„ì‚° ë° ëª©ë¡ ê°±ì‹ ] ---
    function changeMonth(delta) {
        // ë‚ ì§œë¥¼ 1ì¼ë¡œ ê³ ì •í•˜ê³  ì›”ì„ ë³€ê²½í•˜ì—¬, 31ì¼ ë“± ëë‚ ì§œì—ì„œ ë°œìƒí•˜ëŠ” ë²„ê·¸ ë°©ì§€
        currDate = new Date(currDate.getFullYear(), currDate.getMonth() + delta, 1);
        renderCalendar();
    }

    async function renderCalendar() {
        const y = currDate.getFullYear(), m = currDate.getMonth();
        document.getElementById('currentMonth').innerText = `${y}ë…„ ${m+1}ì›”`;
        const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
        
        const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
        days.forEach((d, i) => grid.innerHTML += `<div class="day-header ${i===0?'sun':''} ${i===6?'sat':''}">${d}</div>`);
        
        const first = new Date(y, m, 1).getDay();
        const last = new Date(y, m + 1, 0).getDate();
        for(let i=0; i<first; i++) grid.innerHTML += `<div></div>`;
        
        const memos = await getAll();
        
        for(let d=1; d<=last; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayMemos = memos.filter(m => m.dateStr === dateStr);
            const holiday = HOLIDAYS[dateStr];
            
            let extraClass = '';
            const dow = new Date(y,m,d).getDay();
            if(dow===0) extraClass += ' sun'; else if(dow===6) extraClass += ' sat';
            if(holiday) extraClass += ' holiday';
            if(currentSelectedDateKey === dateStr) extraClass += ' selected-day';

            const div = document.createElement('div');
            div.className = 'cal-day' + extraClass + (dayMemos.length>0 ? ' has-memo' : '');
            if(dateStr === new Date().toISOString().substring(0,10)) div.classList.add('today');

            let pcEvents = '';
            dayMemos.slice(0, 3).forEach(m => { pcEvents += `<div class="cal-event-item" onclick="event.stopPropagation(); openViewModal(${m.id})">${m.title}</div>`; });
            if(dayMemos.length > 3) pcEvents += `<div class="more-items">+${dayMemos.length - 3}</div>`;

            const holidayHtml = holiday ? `<div class="holiday-name">${holiday}</div>` : '';
            div.innerHTML = `<span class="day-num">${d}</span>${holidayHtml}${dayMemos.length>0?'<div class="dot"></div>':''}<div class="cal-events-pc">${pcEvents}</div>`;
            
            if(dayMemos.length > 0) div.onclick = () => showDayMemos(dateStr, memos);
            else div.onclick = () => { document.getElementById('inputDate').value = dateStr; switchTab('write'); };

            grid.appendChild(div);
        }

        // [í•µì‹¬] ëª©ë¡ í‘œì‹œ ë¡œì§: í˜„ì¬ ë³´ê³  ìˆëŠ” ë‹¬ë ¥ì— ì„ íƒëœ ë‚ ì§œê°€ í¬í•¨ë˜ì–´ ìˆì„ ë•Œë§Œ ëª©ë¡ì„ ë³´ì—¬ì¤Œ
        const listContainer = document.getElementById('calendarMemos');
        if (currentSelectedDateKey) {
            const [selY, selM] = currentSelectedDateKey.split('-').map(Number);
            // í˜„ì¬ ë‹¬ë ¥(y, m+1)ê³¼ ì„ íƒëœ ë‚ ì§œ(selY, selM)ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
            if (selY === y && selM === m + 1) {
                const targetMemos = memos.filter(m => m.dateStr === currentSelectedDateKey);
                renderBottomList(currentSelectedDateKey, targetMemos);
            } else {
                listContainer.innerHTML = ''; // ë‹¤ë¥¸ ë‹¬ì´ë©´ ëª©ë¡ ìˆ¨ê¹€ (ì´ˆê¸°í™” íš¨ê³¼)
            }
        } else {
            listContainer.innerHTML = '';
        }
    }

    function showDayMemos(dateStr, memos) {
        currentSelectedDateKey = dateStr; // ì„ íƒ ìƒíƒœ ì €ì¥
        renderCalendar(); // ë‹¬ë ¥ ì¬ë Œë”ë§ (ì„ íƒíš¨ê³¼ ë° ëª©ë¡ í‘œì‹œ)
    }

    function renderBottomList(dateStr, targetMemos) {
        const box = document.getElementById('calendarMemos');
        let html = `<div style="text-align:left; background:#fff; padding:15px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1);">
            <h3 style="margin:0 0 15px 0; font-size:1.1rem; color:var(--primary-color); border-bottom:2px solid var(--accent-color); padding-bottom:8px;">ğŸ“… ${dateStr}</h3>`;
        targetMemos.forEach(m => {
             html += `<div onclick="openViewModal(${m.id})" style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;">
                <div style="font-weight:bold; color:#333;">Q. ${m.title} ${m.attachments&&m.attachments.length>0?'ğŸ“':''}</div>
            </div>`;
        });
        html += `</div>`;
        box.innerHTML = html;
        box.scrollIntoView({behavior:'smooth'});
    }

    async function saveNewMemo() {
        const title = document.getElementById('inputTitle').value;
        const content = document.getElementById('inputContent').value;
        const tags = Array.from(inputSelectedTags);
        const links = collectLinks('inputLinkContainer');
        const dateVal = document.getElementById('inputDate').value;
        const fileInput = document.getElementById('inputFile');
        if(!title || !content) return alert('ë§¥ë½ê³¼ ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        let attachments = [];
        if(fileInput.files.length > 0) {
            for(let i=0; i<fileInput.files.length; i++) {
                if(fileInput.files[i].size > 10 * 1024 * 1024) alert(`[ì£¼ì˜] ${fileInput.files[i].name} 10MB ì´ˆê³¼`);
                attachments.push(await readFile(fileInput.files[i]));
            }
        }
        const store = db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME);
        store.add({ id: Date.now(), dateStr: dateVal, title: title, tags: tags, content: content, links: links, attachments: attachments }).onsuccess = () => {
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            document.getElementById('inputTitle').value = ""; document.getElementById('inputContent').value = ""; document.getElementById('inputFile').value = ""; document.getElementById('fileListDisplay').innerText = ""; document.getElementById('inputLinkContainer').innerHTML = ""; addLinkField('inputLinkContainer'); inputSelectedTags.clear(); updateTagSelects(); switchTab('calendar'); 
        };
    }
    
    async function openViewModal(id) {
        const m = await new Promise(r => db.transaction(STORE_NAME).objectStore(STORE_NAME).get(id).onsuccess = e => r(e.target.result));
        if(!m) return;
        document.getElementById('viewIdHidden').value = m.id; document.getElementById('viewTitle').innerText = "Q. " + m.title; document.getElementById('viewDate').innerText = m.dateStr;
        document.getElementById('viewTagList').innerHTML = (m.tags||[]).map(t => `<span class="mini-tag" style="background:var(--accent-color); color:white;">${t}</span>`).join('');
        document.getElementById('viewBody').innerHTML = marked.parse(m.content);
        const links = m.links || [];
        document.getElementById('viewLink').innerHTML = links.map((l,i) => `<a href="${l}" target="_blank" style="display:block; background:#f1f5f9; padding:10px; margin-bottom:5px; border-radius:8px; text-decoration:none; color:#2980b9; font-weight:bold;">ğŸ”— ê´€ë ¨ ë§í¬ ${i+1}</a>`).join('');
        const attachBox = document.getElementById('viewAttachments'); const attachList = document.getElementById('attachList'); attachList.innerHTML = '';
        if(m.attachments && m.attachments.length > 0) {
            attachBox.style.display = 'block';
            m.attachments.forEach(file => {
                const isImg = file.type.startsWith('image/');
                let html = `<a href="${file.data}" download="${file.name}" class="attach-item"><span class="attach-icon">${isImg?'ğŸ–¼ï¸':'ğŸ“„'}</span><span class="attach-name">${file.name}</span><span style="font-size:0.8rem;color:#888;">ë‹¤ìš´ë¡œë“œ</span></a>`;
                if(isImg) html += `<div class="img-preview-box"><img src="${file.data}"></div>`;
                attachList.innerHTML += html;
            });
        } else { attachBox.style.display = 'none'; }
        document.getElementById('viewModal').style.display = 'flex';
    }

    function openTagManager(){renderTagListModal();document.getElementById('tagManagerModal').style.display='flex'}
    function closeTagManager(){document.getElementById('tagManagerModal').style.display='none'}
    function renderTagListModal(){document.getElementById('tagListDisplay').innerHTML=myTags.map(t=>`<span class="tag-item">${t} <span class="tag-del-btn" onclick="removeTag('${t}')">Ã—</span></span>`).join('')}
    function addNewTag(){const val=document.getElementById('newTagInput').value.trim();if(!val)return;if(!myTags.includes(val)){myTags.push(val);saveTags();document.getElementById('newTagInput').value='';renderTagListModal();updateTagSelects()}}
    function removeTag(tag){if(confirm('ì‚­ì œ?')){myTags=myTags.filter(t=>t!==tag);saveTags();renderTagListModal();updateTagSelects()}}
    function saveTags(){localStorage.setItem('insightTags',JSON.stringify(myTags))}
    function updateTagSelects(){const opts=myTags.map(t=>`<option value="${t}">${t}</option>`).join('');const cur=document.getElementById('listFilter').value;document.getElementById('listFilter').innerHTML=`<option value="all">ì „ì²´ë³´ê¸°</option>`+opts;document.getElementById('listFilter').value=cur;renderTagSelector('inputTagContainer',inputSelectedTags)}
    function renderTagSelector(cid,set){const c=document.getElementById(cid);c.innerHTML='';myTags.forEach(t=>{const b=document.createElement('span');b.className='tag-chip-btn'+(set.has(t)?' active':'');b.innerText=t;b.onclick=()=>{if(set.has(t))set.delete(t);else set.add(t);renderTagSelector(cid,set)};c.appendChild(b)})}
    function addLinkField(cid){const c=document.getElementById(cid);const d=document.createElement('div');d.className='link-row';d.innerHTML=`<input type="text" class="link-input" placeholder="https://..."><button class="btn-del-link" onclick="this.parentElement.remove()">-</button>`;c.appendChild(d)}
    function collectLinks(cid){return Array.from(document.querySelectorAll(`#${cid} .link-input`)).map(i=>i.value.trim()).filter(v=>v)}
    function toggleSelectMode(){isSelectionMode=!isSelectionMode;selectedIds.clear();const b=document.getElementById('selectModeBtn');const bar=document.getElementById('bulkDeleteBar');if(isSelectionMode){b.classList.add('active');bar.style.display='block';updateBulkBar()}else{b.classList.remove('active');bar.style.display='none'}renderMemos()}
    function toggleSelectCard(id){if(selectedIds.has(id))selectedIds.delete(id);else selectedIds.add(id);renderMemos();updateBulkBar()}
    function updateBulkBar(){document.getElementById('selectedCount').innerText=selectedIds.size}
    function deleteSelectedMemos(){if(!confirm('ì‚­ì œ?'))return;const tx=db.transaction(STORE_NAME,'readwrite');selectedIds.forEach(id=>tx.objectStore(STORE_NAME).delete(id));tx.oncomplete=()=>{toggleSelectMode();renderMemos();renderCalendar()}}
    function switchTab(t){window.scrollTo(0,0);document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));document.getElementById('tab-'+t).classList.add('active');const tabs=['calendar','list','write','data'];document.querySelectorAll('.nav-item')[tabs.indexOf(t)].classList.add('active');if(t==='list')renderMemos();if(t==='calendar'){currDate=new Date();renderCalendar()}}
    async function renderMemos(){const l=document.getElementById('memoList');l.innerHTML='';const memos=await getAll();const filter=document.getElementById('listFilter').value;const key=document.getElementById('searchInput').value.toLowerCase();const sVal=document.getElementById('filterStartDate').value;const eVal=document.getElementById('filterEndDate').value;memos.sort((a,b)=>b.dateStr.localeCompare(a.dateStr)||b.id-a.id);memos.forEach(m=>{if(filter!=='all'&&!(m.tags||[]).includes(filter))return;if(key&&!m.title.toLowerCase().includes(key)&&!m.content.toLowerCase().includes(key))return;if(sVal&&m.dateStr<sVal)return;if(eVal&&m.dateStr>eVal)return;const tagsHtml=(m.tags||[]).map(t=>`<span class="mini-tag">${t}</span>`).join(' ');const isSel=selectedIds.has(m.id);const clk=isSelectionMode?`toggleSelectCard(${m.id})`:`openViewModal(${m.id})`;l.innerHTML+=`<div class="memo-card ${isSel?'selected':''} ${isSelectionMode?'selection-mode':''}" onclick="${clk}"><div class="check-circle"></div><div style="display:flex;justify-content:space-between;color:#888;font-size:0.8rem;margin-bottom:5px;"><span>${m.dateStr}</span><div class="card-tags">${tagsHtml}</div></div><h3 style="color:#2c3e50;">Q. ${m.title} ${m.attachments&&m.attachments.length>0?'ğŸ“':''}</h3><p>${m.content.substring(0,50)}...</p></div>`})}
    function closeViewModal(){document.getElementById('viewModal').style.display='none'}
    function deleteFromView(){if(!confirm('ì‚­ì œ?'))return;const id=Number(document.getElementById('viewIdHidden').value);db.transaction(STORE_NAME,'readwrite').objectStore(STORE_NAME).delete(id).onsuccess=()=>{closeViewModal();renderCalendar();renderMemos()}}
    function getAll(){return new Promise(r=>db.transaction(STORE_NAME,'readonly').objectStore(STORE_NAME).getAll().onsuccess=e=>r(e.target.result))}
    function backupData(){getAll().then(d=>{if(d.length==0)return alert('ë°ì´í„° ì—†ìŒ');const b=new Blob([JSON.stringify({version:"v3.4",insights:d,tags:myTags})],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`Insight_Backup_${new Date().toISOString().slice(0,10)}.json`;a.click()})}
    function restoreData(i){const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);const l=d.insights||d;if(d.tags){myTags=d.tags;saveTags()}const tx=db.transaction(STORE_NAME,'readwrite');l.forEach(i=>tx.objectStore(STORE_NAME).put(i));tx.oncomplete=()=>{alert('ë³µì› ì™„ë£Œ');location.reload()}}catch(e){alert('íŒŒì¼ ì˜¤ë¥˜')}};r.readAsText(f)}
    function resetApp(){if(confirm('ì´ˆê¸°í™”?')){db.transaction(STORE_NAME,'readwrite').objectStore(STORE_NAME).clear().onsuccess=()=>{location.reload()}}}
</script>
</body>
</html>
